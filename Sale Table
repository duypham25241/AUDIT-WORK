-- Create Stagting table
CREATE TABLE ProvinceSale_raw (
    order_type NVARCHAR(MAX),
    department_code NVARCHAR(MAX),
    region_province_code NVARCHAR(MAX),
    ou_code NVARCHAR(MAX),
    store_ou_code NVARCHAR(MAX),
    management_account_code NVARCHAR(MAX),
    sale_date NVARCHAR(MAX),
    customer_code NVARCHAR(MAX),
    customer_name NVARCHAR(MAX),
    customer_type NVARCHAR(MAX),
    customer_segment NVARCHAR(MAX),
    walkin_customer_name NVARCHAR(MAX),
    walkin_customer_phone NVARCHAR(MAX),
    warehouse_code NVARCHAR(MAX),
    item_code NVARCHAR(MAX),
    item_name NVARCHAR(MAX),
    lot_number NVARCHAR(MAX),
    warehouse_entry_date NVARCHAR(MAX),
    production_date NVARCHAR(MAX),
    item_type NVARCHAR(MAX),
    sales_channel NVARCHAR(MAX),
    payment_method NVARCHAR(MAX),
    product_group_code NVARCHAR(MAX),
    transaction_uom NVARCHAR(MAX),
    transaction_qty NVARCHAR(MAX),
    uom_level1 NVARCHAR(MAX),
    qty_level1 NVARCHAR(MAX),
    uom_level2 NVARCHAR(MAX),
    qty_level2 NVARCHAR(MAX),
    cost_price_trans_uom1 NVARCHAR(MAX),
    cost_price_uom1 NVARCHAR(MAX),
    cost_price_trans_uom2 NVARCHAR(MAX),
    cost_price_uom2 NVARCHAR(MAX),
    cost_price_trans_uom3 NVARCHAR(MAX),
    cost_price_uom3 NVARCHAR(MAX),
    total_cost NVARCHAR(MAX),
    revenue NVARCHAR(MAX),
    gross_profit NVARCHAR(MAX),
    freight_terms NVARCHAR(MAX),
    shipping_method NVARCHAR(MAX),
    outsourcing_cost NVARCHAR(MAX),
    sales_order_no NVARCHAR(MAX),
    pos_web_no NVARCHAR(MAX),
    ar_transaction_no NVARCHAR(MAX),
    tax_code NVARCHAR(MAX),
    driver_name NVARCHAR(MAX),
    sales_person NVARCHAR(MAX),
    store_name NVARCHAR(MAX),
    location_code NVARCHAR(MAX),
    special_policy NVARCHAR(MAX),
    hoa_sen_voucher NVARCHAR(MAX),
    supplier_voucher NVARCHAR(MAX),
    commission_type NVARCHAR(MAX),
    commission_rate NVARCHAR(MAX),
    total_amount NVARCHAR(MAX),
    invoice_no NVARCHAR(MAX),
    delivery_address NVARCHAR(MAX)
);

--LOAD DATA INTO RAW TABLE
-- M1.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M1.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
-- M2.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M2.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M3.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M3.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M4.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M4.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M5.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M5.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M6.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M6.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M7.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M7.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M8.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M8.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M9.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M9.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M10.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M10.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M11.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M11.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M12.25
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2025.M12.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);
--M1.26
BULK INSERT ProvinceSale_draw
FROM 'D:\Downloads\DATA\OM157\2026.M1.csv'
WITH (
    FIRSTROW=2,
    FIELDTERMINATOR=';',
    ROWTERMINATOR='\n',
    DATAFILETYPE='char',
    CODEPAGE = '65001',
    TABLOCK,
    MAXERRORS = 1000
);

--CREATE MAIN TABLE
CREATE TABLE ProvinceSale_Clean (
order_type NVARCHAR(MAX),
department_code NVARCHAR(MAX),
region_province_code NVARCHAR(MAX),
ou_code NVARCHAR(MAX),
store_ou_code NVARCHAR(MAX),
management_account_code NVARCHAR(MAX),
ngayxuatban DATE,
customer_code NVARCHAR(MAX),
customer_name NVARCHAR(MAX),
customer_type NVARCHAR(MAX),
customer_segment NVARCHAR(MAX),
walkin_customer_name NVARCHAR(MAX),
walkin_customer_phone NVARCHAR(MAX),
warehouse_code NVARCHAR(MAX),
item_code NVARCHAR(MAX),
item_name NVARCHAR(MAX),
lot_number NVARCHAR(MAX),
ngaynhapkho DATE,
ngaysanxuat DATE,
item_type NVARCHAR(MAX),
sales_channel NVARCHAR(MAX),
payment_method NVARCHAR(MAX),
product_group_code NVARCHAR(MAX),
transaction_uom NVARCHAR(MAX),
SLgiaodich DECIMAL(18,2),
uom_level1 NVARCHAR(MAX),
SL1 DECIMAL(18,2),
uom_level2 NVARCHAR(MAX),
SL2 DECIMAL(18,2),
cost_price_trans_uom1 DECIMAL(18,2),
cost_price_uom1 DECIMAL(18,2),
cost_price_trans_uom2 DECIMAL(18,2),
cost_price_uom2 DECIMAL(18,2),
cost_price_trans_uom3 DECIMAL(18,2),
cost_price_uom3 DECIMAL(18,2),
total_cost DECIMAL(18,2),
revenue DECIMAL(18,2),
gross_profit DECIMAL(18,2),
freight_terms NVARCHAR(MAX),
shipping_method NVARCHAR(MAX),
chiphi_giacongngoai DECIMAL(18,2),
sales_order_no NVARCHAR(MAX),
pos_web_no NVARCHAR(MAX),
ar_transaction_no NVARCHAR(MAX),
tax_code NVARCHAR(MAX),
driver_name NVARCHAR(MAX),
sales_person NVARCHAR(MAX),
store_name NVARCHAR(MAX),
location_code NVARCHAR(MAX),
special_policy NVARCHAR(MAX),
hoa_sen_voucher NVARCHAR(MAX),
supplier_voucher NVARCHAR(MAX),
commission_type NVARCHAR(MAX),
mucchihh DECIMAL(18,2),
thanhtien DECIMAL(18,2),
invoice_no NVARCHAR(MAX),
delivery_address NVARCHAR(MAX)
);


--TRANSFORM DATA
SELECT order_type
      ,department_code
      ,region_province_code
      ,ou_code
      ,store_ou_code
      ,management_account_code
      ,TRY_CONVERT(DATE,sale_date,103) sale_date
      ,customer_code
      ,customer_name
      ,customer_type
      ,customer_segment
      ,walkin_customer_name
      ,walkin_customer_phone
      ,warehouse_code
      ,item_code
      ,item_name
      ,lot_number
      ,TRY_CONVERT(DATE,warehouse_entry_date,103) warehouse_entry_date
      ,TRY_CONVERT(DATE,production_date,103) production_date
      ,item_type
      ,sales_channel
      ,payment_method
      ,product_group_code
      ,transaction_uom
      ,TRY_CONVERT(decimal,transaction_qty) transaction_qty
      ,uom_level1
      ,TRY_CONVERT(decimal,qty_level1) qty_level1
      ,uom_level2
      ,TRY_CONVERT(decimal,qty_level2) qty_level2
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(cost_price_trans_uom1)),'.',''),',','.')) AS cost_price_trans_uom1
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(cost_price_uom1)),'.',''),',','.')) AS cost_price_uom1
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(cost_price_trans_uom2)),'.',''),',','.')) AS cost_price_trans_uom2
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(cost_price_uom2)),'.',''),',','.')) AS cost_price_uom2
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(cost_price_trans_uom3)),'.',''),',','.')) AS cost_price_trans_uom3
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(cost_price_uom3)),'.',''),',','.')) AS cost_price_uom3
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(total_cost)),'.',''),',','.')) AS total_cost
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(revenue)),'.',''),',','.')) AS revenue
      ,TRY_CONVERT(decimal(18,2),REPLACE(REPLACE(LTRIM(RTRIM(gross_profit)),'.',''),',','.')) AS gross_profit
      ,freight_terms
      ,shipping_method
      ,REPLACE(REPLACE(LTRIM(RTRIM(outsourcing_cost)),'.',''),',','.') outsourcing_cost
      ,sales_order_no
      ,pos_web_no
      ,ar_transaction_no
      ,tax_code
      ,driver_name
      ,sales_person
      ,store_name
      ,location_code
      ,special_policy
      ,hoa_sen_voucher
      ,supplier_voucher
      ,commission_type
      ,REPLACE(REPLACE(LTRIM(RTRIM(commission_rate)),'.',''),',','.') commission_rate
      ,REPLACE(REPLACE(LTRIM(RTRIM(total_amount)),'.',''),',','.') total_amount
      ,invoice_no
      ,delivery_address
  FROM ProvinceSale

-- INSERT CLEANED DATA INTO MAIN TABLE
-- CHECK DATA IN TABLE
  SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    CHARACTER_MAXIMUM_LENGTH,
    IS_NULLABLE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'ProvinceSale'
ORDER BY ORDINAL_POSITION;
EXEC sp_help 'ProvinceSale'
SELECT COUNT(*) AS total_rows
FROM ProvinceSale;
SELECT
    COUNT(revenue) AS count_non_null,
    COUNT(*) - COUNT(revenue) AS null_count,
    MIN(revenue) AS min_value,
    MAX(revenue) AS max_value,
    AVG(revenue) AS avg_value,
    STDEV(revenue) AS std_dev
FROM ProvinceSale;
